#!/bin/bash

# TODO: Handle automatic positive/negative detection
# TODO: Resize to fit in actual folder region
# TODO: use variable in folderify

SCRIPT_DIR="`dirname $0`"
SCRIPT_NAME="`basename $0`"

FOLDER_ICONS_FOLDER="`dirname $0`/scaled_folders"
FILE="$1"
OUT_FILE_NAME="${FILE%.*}_folder"



function show_help {
cat <<HEREDOC

Usage: $SCRIPT_NAME <file.png>

- The file should be an image with a transparent background (i.e. the corners should be transparent).
- $SCRIPT_NAME will produce 5 folder icon images at different resolutions.
  - These can be combined into a .icns file using a tool like "Icon Composer" or png2icns.
  - The .icns file can be assigned as the icon of a file a tool like IconDroplet (another alternative is to assign the icon to an XCode OSX application project and build)
  - The icon can be copied to a folder using the "Get Info" pane in the Finder.

HEREDOC
}



function echocol {
 echo -e "\033[1;$1m$2\033[0m"
}



if [ $# -ne 1 ]
then
	echo ""
	echocol 31 "ERROR - Incorrect number of arguments: $#"
	show_help
	exit 1
fi




if [ ! -f "${FILE}" ]
then
	echo ""
	echocol 31 "ERROR - Not a file: ${FILE}"
	show_help
	exit 1
fi



function folderify {

	FILE="$1"
	TEMP_FILE_OUT="$2"
	TEMP_FILE="`mktemp /tmp/folderify_img.XXXXXX`"
	scale="$3"
	main_opacity="$4"
	offset_white="$5"
	opacity_white="$6"
	offset_black="$7"
	width="$8"
	height="$9"
	offset_center="${10}"

	convert "${FILE}" -trim -resize "${width}x${height}>" -bordercolor none -border 10 "${TEMP_FILE}"

	convert "$FOLDER_ICONS_FOLDER/folder_$scale.png" \( \( "${TEMP_FILE}" -negate -colorize 3,23,40 -negate \) \
	\( \
		\( \
			\( \
				"${TEMP_FILE}" \
				\( \
					"${TEMP_FILE}" -negate -shadow 100x1+10+0 -geometry -2-2 \
				\) \
				-compose dst-out -composite +repage \
			\) \
			\( \
				"${TEMP_FILE}" \
				\( \
					"${TEMP_FILE}" -negate -geometry +0-1 \
				\) \
				-compose dst-out -composite +repage -negate -geometry +0+${offset_white} \
			\) \
			-compose dissolve -define compose:args=${opacity_white}x50 -composite +repage \
		\) \
		\( \
			"${TEMP_FILE}" \
			\( \
				"${TEMP_FILE}" -negate -geometry +0+1 \
			\) \
			-compose dst-out -composite +repage \
		\) \
		-compose dissolve -define compose:args=50x80 -composite \
	\) \
	-compose dissolve -define compose:args=60x$main_opacity -composite +repage \
	-gravity Center -geometry +0+${offset_center} \
	+repage \
	\) \
	-compose over -composite  "${TEMP_FILE_OUT}"

	rm "${TEMP_FILE}"
 }


echo "Making icon file for ${FILE}"


echo "16x16..."
TEMP_FILE_16="`mktemp /tmp/folderify_16.XXXXXX`"
folderify "$FILE" "${TEMP_FILE_16}" 16 24   1 50   1    12 8 1

echo "32x32..."
TEMP_FILE_32="`mktemp /tmp/folderify_32.XXXXXX`"
folderify "$FILE" "${TEMP_FILE_32}" 32 20   1 75   1    26 14 2

echo "128x128..."
TEMP_FILE_128="`mktemp /tmp/folderify_128.XXXXXX`"
folderify "$FILE" "${TEMP_FILE_128}" 128 16   2 100   1    103 60 9

echo "256x256..."
TEMP_FILE_256="`mktemp /tmp/folderify_256.XXXXXX`"
folderify "$FILE" "${TEMP_FILE_256}" 256 12   2 100   1    206 121 18

echo "512x512..."
TEMP_FILE_512="`mktemp /tmp/folderify_512.XXXXXX`"
folderify "$FILE" "${TEMP_FILE_512}" 512 12   2 100   1    412 242 36

echo ${OUT_FILE_NAME}

# Make the .icns file.

"${SCRIPT_DIR}/lib/makeicns" \
-16 "${TEMP_FILE_16}" \
-32 "${TEMP_FILE_32}" \
-128 "${TEMP_FILE_128}" \
-256 "${TEMP_FILE_256}" \
-512 "${TEMP_FILE_512}" \
-out "${OUT_FILE_NAME}.icns"

rm "${TEMP_FILE_16}" "${TEMP_FILE_32}" "${TEMP_FILE_128}" "${TEMP_FILE_256}" "${TEMP_FILE_512}"

# Make the rsrc file.

TEMP_RSRC_FILE="`mktemp /tmp/folderify_rsrc.XXXXXX`"

python "${SCRIPT_DIR}/lib/lgicns2rsrc.py" "${OUT_FILE_NAME}.icns" "${TEMP_RSRC_FILE}"

#Assignt the rsrc file to the icon itself.

echo "Assigning icon to ${OUT_FILE_NAME}.icns file itself."

/Developer/Tools/Rez -append "${TEMP_RSRC_FILE}" -o "${OUT_FILE_NAME}.icns"

SetFile -a C "${OUT_FILE_NAME}.icns"

rm "${TEMP_RSRC_FILE}"

echo "Done. Icon file is at ${OUT_FILE_NAME}.icns"